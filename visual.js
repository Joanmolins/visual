/*
Visual
Copyright (c) 2013 Institut d'Estadistica de Catalunya (Idescat)
http://www.idescat.cat (https://github.com/idescat/visual)

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
var VisualJS={version:"0.4.2",unit:{label:"",symbol:"",position:"end"},dec:null,legend:!0,autoheading:!0,show:!0,filter:.05,fixed:null,width:500,bwidth:500,height:500,normal:500,scripts:[],map:{},container:{},func:{},callback:null,draw:function(){VisualJS.tooltip(),VisualJS.show&&VisualJS.chart(),window.onresize=function(){VisualJS.canvas()},null!==VisualJS.callback&&VisualJS.callback.call(VisualJS.id)},tooltip:function(){var a=document;if(!a.getElementById(VisualJS.setup.tooltipid)){var b=a.createElement("div");b.id=VisualJS.setup.tooltipid,b.style.display="none",a.body.appendChild(b)}},getsize:function(a){var b=VisualJS.setup,c=b.html,d=c.heading,e=c.footer,f=window,g=document,h=g.documentElement,i=g.getElementsByTagName("body")[0],j=g.getElementById(a),k=j.getElementsByTagName(d)[0].clientHeight,l=j.getElementsByTagName(e)[0].clientHeight,m=f.innerHeight||h.clientHeight||i.clientHeight;"undefined"!=typeof m&&"undefined"!=typeof k&&"undefined"!=typeof l&&(null===VisualJS.fixed?(VisualJS.bwidth=f.innerWidth||h.clientWidth||i.clientWidth,VisualJS.width=VisualJS.bwidth-b.padding.w,VisualJS.height=m-b.padding.h-k-l):(VisualJS.bwidth=h.clientWidth||i.clientWidth,VisualJS.width=VisualJS.fixed[0]-b.padding.w,VisualJS.height=VisualJS.fixed[1]-b.padding.h-k-l)),VisualJS.visualsize=VisualJS.width<VisualJS.normal?b.mini:b.normal},atext:function(a){return String(a).replace(/&amp;/g,"&")},getHeading:function(a){if(VisualJS.autoheading===!1)return a.title;var b=[],c=function(a,c){"string"==typeof a&&(c===!0&&(a='<span class="'+VisualJS.setup.nowrapclass+'">'+a+"</span>"),b.push(a))};if(null!==a.time&&"object"==typeof a.time)var d=VisualJS.tformat(a.time[0]),e=VisualJS.tformat(a.time[a.time.length-1]),f=d+"&ndash;"+e;else var f=VisualJS.tformat(a.time);return c(a.title,!1),c(a.geo,!0),null!==f&&c(f,!0),VisualJS.atext(b.join(". "))},addJS:function(a,b){return b&&a.exists.call()?!1:(VisualJS.scripts.push(a.js),!0)},showTooltip:function(a,b,c){var d=document.getElementById(VisualJS.setup.tooltipid),e=VisualJS.bwidth-VisualJS.setup.margin,f={};d.innerHTML=a,d.style.display="block";var g=d.clientWidth/2;f.x=b-g,f.y=c-d.clientHeight-5,b+g>e?f.x-=b+g-e:f.x<VisualJS.setup.margin&&(f.x+=VisualJS.setup.margin-f.x),f.y<VisualJS.setup.margin&&(f.y+=1.75*d.clientHeight),d.style.left=f.x+"px",d.style.top=f.y+"px"},format:function(a){if("undefined"==typeof a||null===a)return VisualJS.setup.i18n.text.na[VisualJS.lang];a+="";for(var b=/(\d+)(\d{3})/,c=a.split("."),d=c[0],e=c.length>1?VisualJS.setup.i18n.text.dec[VisualJS.lang]+c[1]:"";b.test(d);)d=d.replace(b,"$1"+VisualJS.setup.i18n.text.k[VisualJS.lang]+"$2");return d+e},tformat:function(a){if(!a)return null;if(isNaN(a))return a;switch(a.length){case 5:var b="quarter";break;case 6:var b="month";break;default:return a}var c=VisualJS.setup.i18n.text[b];if("undefined"==typeof c)return a;var d=c[VisualJS.lang];return"undefined"==typeof d?a:d[a.slice(4)-1]+" <span>"+a.slice(0,4)+"</span>"},tooltipText:function(a,b,c){var d=VisualJS.container[a].dec,e=" "+VisualJS.container[a].unit.label,f=c?VisualJS.container[a].unit.symbol:"",c=c&&null!==d?c.toFixed(d):c,g=VisualJS.format(c),h="end"===VisualJS.container[a].unit.position?g+e+" "+f:f+g+e;return b?"<strong>"+h+"</strong> "+b:h},load:function(a){function b(a){return"[object Array]"===Object.prototype.toString.call(a)}if("undefined"==typeof VisualJS.setup&&window.alert("Visual: Setup not found (visual.setup.js)!"),b(a))for(var c=0,d=a.length;d>c;c++)VisualJS.get(a[c]);else VisualJS.get(a)},get:function(a){var b=VisualJS.setup,c=b.html,d=c.heading,e=c.footer,f=b.func.old("ie9");VisualJS.id="undefined"!=typeof a.id?a.id:b.id,"undefined"!=typeof a.fixed&&(VisualJS.fixed=a.fixed),VisualJS.container[VisualJS.id]="undefined"!=typeof a.unit?{unit:{label:"undefined"!=typeof a.unit.label?a.unit.label:VisualJS.unit.label,symbol:"undefined"!=typeof a.unit.symbol?a.unit.symbol:VisualJS.unit.symbol,position:"undefined"!=typeof a.unit.position?a.unit.position:VisualJS.unit.position}}:{unit:VisualJS.unit},VisualJS.container[VisualJS.id].dec="number"==typeof a.dec?a.dec:VisualJS.dec,VisualJS.show="boolean"==typeof a.show?a.show:VisualJS.show,VisualJS.autoheading="boolean"==typeof a.autoheading?a.autoheading:VisualJS.autoheading,VisualJS.legend="boolean"==typeof a.legend?a.legend:VisualJS.legend,VisualJS.lang=a.lang||b.i18n.lang,VisualJS.callback="function"==typeof a.callback?a.callback:VisualJS.callback;var g="#"+VisualJS.id,h=g+" ."+b.canvasclass;if("cmap"===a.type)if(f)document.getElementById(VisualJS.id).innerHTML="<p>"+b.i18n.text.oldbrowser[VisualJS.lang]+"</p>";else{if("string"!=typeof a.by)return;VisualJS.addJS(b.lib.maps,!0),VisualJS.addJS(b.lib.d3,!0),VisualJS.addJS(b.map[a.by],!0),VisualJS.chart=function(){var c=VisualJS.map[a.by],f=c.area[0],h=c.area[1],i="undefined"!=typeof a.filter?a.filter:VisualJS.filter,j=1-i,k="object"==typeof a.grouped&&a.grouped.length>0&&a.data[0].hasOwnProperty("group"),l=!k&&a.data[0].hasOwnProperty("val"),m=k?a.grouped.length:l?b.colors.map.max:1,n=VisualJS.func.colors(b.colors.map.base,m,"fill","q"),o=d3.select(g),p=d3.geo[c.projection](),q="object"==typeof c.center&&"function"==typeof p.center?p.center(c.center):p,r=q.scale(c.scale).translate([f/2,h/2]),s=d3.geo.path().projection(r),t=d3.select("#"+b.tooltipid);VisualJS.canvas=function(){o.html("<"+d+"></"+d+"><"+e+"></"+e+">"),d3.select(g+" "+d).html(VisualJS.getHeading(a)),d3.select(g+" "+e).html(VisualJS.atext(a.footer||"")),VisualJS.getsize(VisualJS.id);var u,x,y,z,A,p=VisualJS.id,q=d3.map(),r=[],v=function(){},w=function(){},B=VisualJS.height/h,C=VisualJS.width/f,D=Math.min(Math.round(f*B),VisualJS.width),E=Math.min(Math.round(h*C),VisualJS.height),F=Math.floor((VisualJS.width-D)/2),G=Math.floor((VisualJS.height-E)/2),H=C>B?B:C,I=o.insert("svg:svg",e).attr("width",D).attr("height",E);k?(u=d3.map(),v=function(a,b){a.set(b.id,b.group)},x=function(a,b,d){return"q"+(a.get(d[c.id])-1)},y=function(b,d){var e=a.grouped[b.get(d[c.id])-1],f=d[c.label];return"undefined"!=typeof e&&(f+=" <em>"+e+"</em>"),f}):(l?(x=function(a,b,d,e,f){var g=d3.scale.quantize().domain([e,f]).range(d3.range(m).map(function(a){return"q"+a}));return g(b.get(d[c.id]))},w=VisualJS.func.legend):x=function(a,b,d){return""!==b.get(d[c.id])?"":"q"+(m-1)},y=function(a,b){return b[c.label]});for(var J=0,K=a.data,L=K.length;L>J;J++){var M=K[J];M.hasOwnProperty("val")?q.set(M.id,M.val):q.set(M.id,""),r.push(M.val),v(u,M)}r.sort(function(a,b){return a-b});var z=d3.quantile(r,i),A=d3.quantile(r,j);I.style("margin-left",F+"px"),I.style("margin-top",G+"px"),I.style("margin-bottom",G+"px"),I.append("svg:g").attr("class",b.areaclass).attr("transform","scale("+H+")").selectAll("path").data(c.features).enter().append("svg:path").attr("class",function(a){return x(u,q,a.properties,z,A)}).attr("d",s).on("mousemove",function(a){(l||"undefined"!=typeof q.get(a.properties[c.id]))&&VisualJS.showTooltip(VisualJS.tooltipText(p,y(u,a.properties),q.get(a.properties[c.id])),d3.event.pageX,d3.event.pageY)}).on("mouseout",function(){return t.style("display","none")}),VisualJS.legend&&"object"==typeof c.legend&&w(p,VisualJS.tooltipText(p,null,A),VisualJS.tooltipText(p,null,z),n[n.length-1],n[0],I,t,c.area,c.legend)},VisualJS.canvas()}}else{if(VisualJS.addJS(b.lib.jquery,!0)){var i=!1;VisualJS.addJS(b.lib.jquery.flot,!1)}else if(VisualJS.addJS(b.lib.jquery.flot,!0))var i=!1;else var i=!0;f&&VisualJS.addJS(b.lib.excanvas,!0);var j=function(){},k=[],l=[],m=[],n=a.stacked||!1,o=function(){var c=function(){};if(n)VisualJS.addJS(b.lib.jquery.flot.stack,i);else if("tsbar"===a.type){VisualJS.addJS(b.lib.jquery.flot.orderbars,i);var c=function(a){return a.bars}}return j=function(b,d){for(var f=0,g=d.length;g>f;f++)l.push([f,d[f]]);for(var f=0,g=b.length;g>f;f++){for(var h=[],i=b[f].val,j=i.length,o=0;j>o;o++)h.push([o,i[o]]);"tsbar"!==a.type||n||1===g?k.push({label:b[f].label,data:h}):k.push({label:b[f].label,data:h,bars:{show:!0,barWidth:.2,order:f+1,lineWidth:2}})}for(var f=0,q=k.length;q>f;f++)m.push({data:k[f].data,label:k[f].label,bars:c(k[f]),shadowSize:4});p=q>1},VisualJS.getHeading(a)};switch(a.type){case"pyram":VisualJS.addJS(b.lib.jquery.flot.pyramid,i),Array.max=function(a){return Math.max.apply(Math,a)};var j=function(a,b,c){max=Math.max(Array.max(a[0].val),Array.max(a[1].val)),k[0]={label:a[0].label,data:[],pyramid:{direction:"L"}},k[1]={label:a[1].label,data:[]};for(var d=0,e=c.length;e>d;d++)k[0].data[d]=[c[d],a[0].val[d]],k[1].data[d]=[c[d],a[1].val[d]]},p=!0,q=!1,r=!1,s=!1,t=!1,u=VisualJS.getHeading(a);break;case"rank":var v=[],j=function(a){for(var d=0,e=a.length;e>d;d++)l[d]=[d,a[e-d-1][0]],v[d]=[a[e-d-1][1],d];k={data:v}},p=!1,q=!1,r=!1,s=!1,t=!0,u=VisualJS.getHeading(a);break;case"bar":VisualJS.addJS(b.lib.jquery.flot.categories,i);var j=function(a){k=a,p=k.length>1},q=!0,r=!1,s=!1,t=!0,u=VisualJS.getHeading(a);break;case"tsline":var u=o(),q=null,r=!0,s=!0,t=!1;break;case"tsbar":var u=o(),q=!0,r=!1,s=!1,t=!0}VisualJS.chart=function(){j(a.data,a.time,a.by),$.fn.UseTooltip=function(c){var d=[];$(this).bind("plothover",function(e,f,g){if(g){if(d!=[g.seriesIndex,g.dataIndex]){d=[g.seriesIndex,g.dataIndex];var h=g.datapoint[0],i=g.datapoint[1],j="bar"!==a.type?g.series.label:k[h][0],m="rank"!==a.type?j:l[i][1],o="rank"!==a.type&&"bar"!==a.type?n||1===k.length?l[h][1]:"pyram"===a.type?g.series.yaxis.ticks[g.dataIndex].label:l[g.dataIndex][1]:!1,p="pyram"===a.type?Math.abs(h):"rank"!==a.type?"tsbar"!==a.type?i:n||1===k.length?k[g.seriesIndex].data[h][1]:i:h;VisualJS.showTooltip(VisualJS.tooltipText(c,o?m+" ("+o+")":m,p),f.pageX,f.pageY)}}else $("#"+b.tooltipid).hide(),d=[]})},p=VisualJS.legend&&p;var c={colors:b.colors.series,series:{stack:q,bars:{show:t,barWidth:.7,align:"center",fill:.9},lines:{show:r},points:{show:s,radius:1}},legend:{show:p},grid:{borderWidth:1,hoverable:!0,clickable:!1,mouseActiveRadius:10},xaxis:{},yaxis:{}};VisualJS.canvas=function(){$(g).html("<"+d+"></"+d+"><"+e+"></"+e+">"),$(g+" "+d).html(u),$(g+" "+e).html(VisualJS.atext(a.footer||"")),VisualJS.getsize(VisualJS.id),$(g+" "+d).after('<div class="'+b.canvasclass+" "+VisualJS.visualsize+'" style="width: '+VisualJS.width+"px; height: "+VisualJS.height+'px;"></div>');var f=l.length;switch(a.type){case"pyram":c.series.pyramid={show:!0,barWidth:1},c.xaxis.max=1.02*max,c.xaxis.tickFormatter=function(a){return VisualJS.format(a)},$.plot(h,k,c);break;case"rank":c.series.bars.horizontal=!0,c.yaxis.ticks=VisualJS.height/f>11?l:0,c.xaxis.max=1.02*a.data[0][1],c.xaxis.tickFormatter=function(a){return VisualJS.format(a)},c.yaxis.autoscaleMargin=0,c.series.bars.barWidth=.5,$.plot(h,[k],c);break;case"bar":c.xaxis.mode="categories",c.xaxis.tickLength=0,c.yaxis.tickFormatter=function(a){return VisualJS.format(a)},$.plot(h,[k],c);break;case"tsline":case"tsbar":var i=function(a){var b=[],d=VisualJS.width/f;switch(a){case"year":if(25>d){for(var e=0;f>e;e++)b[e]=e%2?[l[e][0],""]:[l[e][0],l[e][1]];c.xaxis.ticks=b}else c.xaxis.ticks=l;break;case"month":case"quarter":var g="month"===a?"01":"1";if(35>d){for(var e=0;f>e;e++)b[e]=l[e][1].slice(4)!==g?[l[e][0],""]:[l[e][0],l[e][1].slice(0,4)],l[e][1]=VisualJS.tformat(l[e][1]);c.xaxis.ticks=b}else{for(var e=0;f>e;e++)l[e][1]=VisualJS.tformat(l[e][1]);c.xaxis.ticks=l}}};switch(c.yaxis.tickFormatter=function(a){return VisualJS.format(a)},l[0][1].length){case 4:i("year");break;case 5:i("quarter");break;case 6:i("month");break;default:c.xaxis.ticks=l}$.plot(h,m,c)}$(h).UseTooltip(VisualJS.id)},VisualJS.canvas()}}VisualJS.scripts.length&&"object"==typeof LazyLoad?LazyLoad.js(VisualJS.scripts,VisualJS.draw):VisualJS.draw()}};if("function"!=typeof visual)var visual=VisualJS.load;